# Analiza statystyczna

This laboratory aims to present static malware analysis using
virtual environment created using VirtualBox, separated from the host - to ensure nothing threaths the work station.

During the task will try to learn the tools and methods of file type identification,
which will translate into determining the purpose of the OS, architecture and format (e.g. dll and exe). 

Besides examining methods of identifying malware by
generating a hash with a unique identifier - made to be scanned in VirusTotal service.

PE headers will be analised.

## Laboratorium 1.1

W tym laboratorium wykorzystaj pliki Lab02-01.exe i Lab02-01.dll. Skorzystaj z narzędzi

przeznaczonych do statycznej analizy i odpowiedz na poniższe pytania.


### 1. Wyciągnij hasha (np. md5 lub sha-1) z plików i sprawdź na stronie www.VirusTotal.com, czy pliki o tych samych sumach kontrolnych zostały wcześniej analizowane pod kątem szkodliwego oprogramowania?




Plik Lab02-01.dll




Plik Lab02-01.exe




Jak widać oba pliki zostały uznane przez VirusTotal za szczególnie złośliwe

Najwcześniejszy rekord analizy plików pochodzi z 2018 roku





### 2. Wykorzystując narzędzie PEview odszukaj informacje o dacie skompilowania programu

Dla pliku Lab02-01.exe nie udało mi się znaleźć informacji o dacie skompilowania programu. Niestety jedna sekcja odmawiała posłuszeństwa i nie chciała się otworzyć `IMAGE_NT_HEADERS` > `IMAGE_SECTION_HEADER.rdata`. A sam program PEview się crashował

Udało mi się znaleźć informację, że to właśnie tam byłaby przechowywana data skompilowania programu





### 3. Często bywa tak, że złośliwe oprogramowanie znajduje się w formie spakowanej lub zaciemnionej utrudniając analizę. Wykorzystaj narzędzie PEiD lub PPEE do sprawdzenia, czy analizowane pliki znajdują się w formie umożliwiającej pełną analizę. Opisz uzyskany rezultat.

Plik Lab02-01.exe jest w formie umożliwiającej pełną analizę




Można łatwo znaleźć informację w formie *plaintext*, a nawet zdeassemblować w czytelnej formie




Podobne wnioski można wyciągnąć dla biblioteki .dll











### 4. W celu statycznego sprawdzenia jak działa złośliwe oprogramowanie, możemy przeanalizować importy do bibliotek wykonywane przez analizowane pliki. Do tego możemy wykorzystać program PE-bear (program posiada funkcjonalność jednoczesnego analizowania dwóch plików). Przeanalizuj wykorzystywane importy do określenia sposobu działania pliku exe oraz dll (Lab02-01.exe i Lab02-01.dll). Opisz wybrane przez ciebie najciekawsze importy (za co odpowiadają?).


### 


Dla biblioteki _Lab02-01.dll_ są to poniższe importy:



* KERNEL32.dll - wywołująca funkcje takie jak Sleep, CreateMutex, CloseHandle przy czym najciekawsza jest właśnie CreateProcess ponieważ program będzie prawdopodobnie próbował stworzyć potomne procesy 
* WS2_32.dll
* MSVCRT.dll - do zarządzania pamięcią - malloc, free, strncmp




Dla pliku Lab02-01.exe importowane są 2 te same biblioteki, jednakże są one bardziej rozbudowane



* KERNEL32.dll - różni się funkcjami odpowiedzialnymi za znajdywanie plików
* MSVCRT.dll - dodatkowo sprawdza wiele wyjątków


### 5. Za co odpowiedzialna jest biblioteka WS2_32.dll (Lab02-01.dll)?

Służy do nawiązywania i zarządzania dynamicznymi połączeniami sieciowymi - Windows Sockets. Aplikacja zawsze działa w RAM’ie


### 6. Wyświetl informacje strings z programu PPEE dla pliku Lab02-01.exe. Zwróć uwagę na ścieżki dostępowe do biblioteki C:\Windows\System32\Kernel32.dll i jego odpowiednika. O czym mogą świadczyć dwa osobne podobne rekordy?




Program wskazał podane 4 rekordy jako podejrzane

W zakładce String in file -> ASCII można również znaleźć wywołania funkcji bibliotek oraz z pozoru losowe ciągi znaków.




Dwa osobne rekordy biblioteki kernel32.dll i kerne132.dll najprawdopodobniej mają za zadanie podmianę oryginalnej biblioteki z zainfekowanym zamiennikiem


### 7. Przeanalizuj tym samym sposobem plik Lab02-01.dll i odpowiedz, czy posiada on jakieś informacje mogące świadczyć o komunikacji internetowej?




Program nie znalazł podejrzanych napisów, dlatego przejdę do próby ręcznego ich znalezienia

Biblioteka ta powiela wiele napisów z poprzedniego pliku wykonywalnego (Lab02-01.exe) jednakże można znaleźć tutaj również pewien adres ip - **127.26.152.13**

Spróbowałem wyszukać powyższy adres w serwisie VirusTotal, jednakże nie znalazł on niczego podejrzanego



### 8. Posiadając aktualne informacje, czy jesteś w stanie określić w jaki sposób działają analizowane pliki oraz opisać zależność miedzy plikami (exe i dll)?

Program wykonywalny ma za zadanie podmianę biblioteki kernel32.dll na kerne132.dll. Następnie najprawdopodobniej łączy się z jakimś serwerem i próbuje nawiązać komunikację. Po drodze uruchamia on wiele innych procesów niezbędnych do działania (poprzez funkcję CreateProcess)


## Laboratorium 1.2

Wykonaj analizę pliku Lab02-02.exe i odpowiedz na pytania.


### 1. Czy sygnatura analizowanego pliku była już wcześniej analizowana w VirusTotal? Jeśli tak, to podaj wynik skanowania.







W skanowaniu wyszło, że próbka jest bardzo szkodliwa - aż 51 na 69 vendor’ów stwierdziło ją jako złośliwą - jest to ewidenty Trojan.

Próbka została dodana już w 2011 roku - a tym samym była już analizowana


### 2. Sprawdź, czy coś świadczy o tym, że plik jest spakowany lub zaciemniony? Spróbuj go rozpakować.




Plik jest w dość znaczącej części w formie skompresowanych plików wykonywalnych (UPX Win32)

**PEiD packer**:  UPX v0.89.6 - v1.02 / v1.05 -v1.24 -> Markus & Laszlo [overlay] 

Do podobnych wniosków można dojść używając programu **PEID**




Plik jest spakowany

Próbuję go odpakować programem **Universal Extractor**







Operacja zakończona pomyślnie


### 3. Wykorzystuj poznane narzędzia do porównania importów pliku spakowanego z rozpakowanym. Podaj jakie są różnice pomiędzy nimi oraz wymień najciekawsze importy z rozpakowanego pliku.

Lab02-02_wypakowany.exe:




Najciekawsze importy

KERNEL32.dll:



* CreateMutexA
* CreateThread
* SetWaitableTimer

ADVAPI32.dll:



* CreateServiceA
* StartServiceCtrlDispatcherA
* OpenSCManagerA

MSVCRT.dll:



* initterm
* setupusermatherr
* exit

WININET.dll:



* InternetOpenUrlA
* InternetOpenA

Lab02-02.exe




Wypakowany posiada znacznie więcej funkcji, pomimo że importują te same biblioteki. 

Tabela różnic (ilość importowanych funkcji):


<table>
  <tr>
   <td>
   </td>
   <td>KERNEL32.dll
   </td>
   <td>ADVAPI32.dll
   </td>
   <td>MSVCRT.dll
   </td>
   <td>WININET.dll
   </td>
  </tr>
  <tr>
   <td>Lab02-02.exe
   </td>
   <td>6
   </td>
   <td>1
   </td>
   <td>1
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Lab02-02_wypakowany.exe
   </td>
   <td>9
   </td>
   <td>3
   </td>
   <td>13
   </td>
   <td>2
   </td>
  </tr>
</table>



### 4. Odszukaj w strings informacje świadczące o połączeniach programu z siecią Internet.

Używam programu PPEE




W zakładce Suspicious jest informacja o pewnej domenie.

Niestety program nie odnalazł żadnego adresu ip - dlatego nie do końca wiadomo, czy powyższa domena to np. źródło pochodzenia pliku czy adres serwera z którym ów wirus próbuje się połączyć


## Laboratorium 1.3

Przeprowadź analizę pliku Lab02-03.exe


### 1. Czy sygnatura analizowanego pliku była już wcześniej analizowana w VirusTotal? Jeśli tak, to podaj wynik skanowania.







Program jest ewidentnie złośliwy


 Również został przeanalizowany w serwisie VirusTotal w 2011 roku 


### 2. Sprawdź, czy coś świadczy o tym, że plik jest spakowany lub zaciemniony? Czy będziesz w stanie rozpakować go przy pomocy UPX? Jeśli nie, to dlaczego?




Plik jest spakowany




Niestety nie udało się go rozpakować, ponieważ nie został spakowany przez UPX


### 3. Czy jesteś w stanie sprawdzić datę kompilacji pliku (Time Data Stamp)?




Wynik nie wydaje się być prawdziwy. Prawdopodobnie został uszkodzony lub celowo nadpisany/wyzerowany


### 4. Wykorzystuj poznane narzędzia do porównania importów pliku, odpowiedz, czy jesteś w stanie sprawdzić funkcjonalność badanego pliku, w taki sam sposób jak w Laboratorium 1.1?




Plik importuje zaledwie jedną bibliotekę - KERNEL32.dll

Dostępne są jednak importy funkcji




Więc nie, nie idzie sprawdzić w taki sam sposób importów jak w Laboratorium 1.1


### 5. Odszukaj w strings informacje świadczące o połączeniach programu z siecią Internet.




Brak rzucających się połączeniach z siecią - być może są w postaci zaciemnonej


## Laboratorium 1.4

Przeprowadź analizę pliku Lab02-04.exe


### 1. Czy sygnatura analizowanego pliku była już wcześniej analizowana w VirusTotal? Jeśli tak, to podaj wynik skanowania.







Sprawa wygląda bardzo podobnie jak w przypadku poprzednich plików


### 2. Sprawdź, czy coś świadczy o tym, że plik jest spakowany lub zaciemniony?


Plik nie został spakowany


### 3. Kiedy ten plik został skompilowany?




30 września 2019


### 4. Wykorzystuj poznane narzędzia do porównania importów pliku, odpowiedz, czy jesteś w stanie sprawdzić funkcjonalność badanego pliku, w taki sam sposób jak w Laboratorium 1.1?




Plik importuje 3 biblioteki oraz szereg następujących funkcji:



* KERNEL32.dll

    


* ADVAPI32.dll

    


* MSVCRT.dll

    



Analizę można przeprowadzić w sposób podobny do sposobu z Laboratorium 1.1

Program najprawdopodobniej używa funkcji z biblioteki KERNEL32.dll do przenoszenia złośliwych plików oraz tworzenia procesów wraz z odpowiednimi uprawnieniami (biblioteka ADVAPI32.dll)


### 5. Odszukaj w strings informacje świadczące o połączeniach programu z siecią Internet.




Podobnie jak w jednym z poprzednich laboratoriów - program nie odnalazł żadnego adresu ip - dlatego nie do końca wiadomo, czy powyższa domena to np. źródło pochodzenia pliku czy adres serwera z którego wirus próbuje coś pobrać


### 6. Czy analizowany plik posiada importy świadczące o dostępie do funkcji sieciowych?




Tak, próbuje on pobrać plik z jakiegoś serwera


### 7. Badany plik zawiera jeden zasób w sekcji zasobów. Użyj programu Resource Haker, aby zbadać ten zasób, a następnie użyj go do jego wyodrębnienia. Wczytaj plik w programie a następnie użyj funkcji „Action->Save Resource to Bin File” Czego możesz się dowiedzieć analizując ten wyeksportowany zasób?




Po otworzeniu pliku w programie PE-bear zmieniła się jedna funkcja ADVAPI32.dll -> urlmon.dll




Zawiera ona wcześniej opisaną funkcję - służącą pobieraniu zasobu z serwera

Biblioteka KERNEL32.dll posiada teraz znacznie mniej importowanych funkcji




MSVCRT.dll wydaje się pozostać niezmieniona

Najprawdopodobniej wirus próbował pierwotnie ukryć swoje działanie w formie importowania innych bibliotek i funkcji - po wyodrębnieniu pokazuje swoje prawdziwe działanie - pobranie pliku z serwera oraz później uruchomienie go za pomocą funkcji `WinExec` 
