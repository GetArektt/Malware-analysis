# Zaawansowana analiza dynamiczna


## Laboratorium 5.1

Przeprowadź analizę pliku Lab06-01.exe za pomocą programu OllyDbg i odpowiedz na

poniższe pytania:


### 1. W jaki sposób można zmusić malware do instalacji?

Po próbie uruchomienia programu z poziomu eksploratora systemu plików Windows - plik wykonywalny znika. Również podobnie w przypadku programu `process explorer` - pierwotnie proces pojawia się na liście, jednak po krótkiej chwili znika


![alt_text](images/image1.png "image_tooltip")


Uruchamia on proces konsoli `cmd.exe` 

Następnie uruchomiłem program `ollydbg` i starałem się znaleźć czegoś związanego z konsolą właśnie


![alt_text](images/image2.png "image_tooltip")


Po analizie sąsiednich adresów można zauważyć, że uruchamia się `Service Manager `odpowiedzialny za instalację.


![alt_text](images/image3.png "image_tooltip")


Niestety nie jestem w stanie sprawdzić w jaki dokładnie sposób wymusić instalację złośliwego oprogramowania

Jedynie co mi wiadomo to, że podczas instalacji próbuje zmienić coś w rejestrze oraz tworzyć pliki - kopiuje pliki do `System32`
![alt_text](images/image4.png "image_tooltip")


Oraz uruchamia kolejne procesy `.exe`


### 2. Podaj argumenty wiersza poleceń dla tego programu. Jakie są wymagania dotyczące hasła?

Zważając na powyższą konstrukcję stringów, można przypuszczać, że po uruchomieniu `cmd` program przyjmuje następujące argumenty



* `-cc`
* `-c`
* `-re`
* `-in`


![alt_text](images/image5.png "image_tooltip")


Następnie trochę wspomogłem się programem `IDA`


![alt_text](images/image6.png "image_tooltip")



![alt_text](images/image7.png "image_tooltip")


Udało mi się znaleźć funkcję odpowiedzialną za przyjmowanie parametru `-in` (który najprawdopodobniej odpowiada za instalację właśnie)


![alt_text](images/image8.png "image_tooltip")


Idąc dalej można zobaczyć że jednymi z liter hasła jest **a** oraz **c**


![alt_text](images/image9.png "image_tooltip")



![alt_text](images/image10.png "image_tooltip")



![alt_text](images/image11.png "image_tooltip")


Każda kolejna litera hasła wywołuje funkcję odpowiadającą za kolejną literę - pierwszą jest **a**, następna jest o inkrementowana, więc będzie to litera **b**, litera **c** jest podana, a czwarta jest znowu o jeden większa od poprzedniej - **d**

W takim razie hasło będzie miało następującą postać - **abcd**


### 3. Jak można wykorzystać OllyDbg do wprowadzenia zmian w tym malware, aby nie wymagał podawania hasła w wierszu poleceń?

Należy nadpisać poszczególne funkcje (wcześniej odnalezione w programie IDA) odpowiedzialne za zwracanie informacji o tym iż sprawdzanie hasła nie zakończyło się sukcesem

Czyli w tym miejscue należy zmusić program do zwracania prawdy
![alt_text](images/image12.png "image_tooltip")


Można to zrobić używając funkcji `mov eax,1` oraz `ret`


![alt_text](images/image13.png "image_tooltip")



### 4. Podaj indykatory hostowe związane z tym malware.

Tak jak w poprzednich plikach - <code>[www.pracitaclmalwareanalysis.com](www.pracitaclmalwareanalysis.com*)</code>
![alt_text](images/image14.png "image_tooltip")



![alt_text](images/image15.png "image_tooltip")


oraz najprawdopodobniej numery portów



* 60
* 80


### 5. Opisz działania umożliwiające wykorzystanie złośliwego pliku przy pomocy sieci Internet.


![alt_text](images/image16.png "image_tooltip")


Program może pobierać coś z sieci (**DOWNLOAD**), uploadować (**UPLOAD**), czekać (**SLEEP**), prawdopodobnie uruchamiać komendę w konsoli (**CMD**) oraz nie robić nic (**NOTHING**)


### 6. Wymień przydatne wskaźniki sieciowe tego malware.


![alt_text](images/image17.png "image_tooltip")


Link URL, numery portów


## Laboratorium 5.2

Przeprowadź analizę pliku Lab06-02.exe za pomocą programu OllyDbg i odpowiedz na

poniższe pytania:



1. Przeanalizuj i wypisz łańcuchy znaków, które jesteśmy w stanie odszukać w pliku.

Są to głównie napisy z importowanych bibliotek, nazwy funkcji i modułów  oraz kody błędów


![alt_text](images/image18.png "image_tooltip")

![alt_text](images/image19.png "image_tooltip")



![alt_text](images/image20.png "image_tooltip")


Z podejrzanych rzeczy udało się znaleźć funkcje odpowiedzialne za pisanie do pliku, zarządzanie procesami i socketami



2.  Opisz wynik działania z uruchomienia tego pliku.

Program się nie uruchamia. Nie widać żadnej aktywności nawet po sprawdzeniu w eksploratorze procesów. Być może program odmawia uruchomienia się z uwagi na to, że wykrywa że jest na wirtualnej maszynie

Nie wiem czy jest to przypadek, ale czasem po uruchomieniu pliku uruchamia się również proces `svchost.exe` - być może malware próbuje wykonać jakieś połączenie internetowe



3. W jaki sposób zmusić analizowany plik do uruchomienia swojej szkodliwej zawartości?

Próbowałem znaleźć informacji z użyciem `OllyDBG` aczkolwiek nie udało mi się znaleźć niczego pomocnego. 

Próbowałem również z użyciem programu IDA aczkolwiek pierowtnie nie udało mi się nic znaleźć.

DOpiero po wykonaniu następnego podpunktu udało mi się uruchomić program -> należy go nazwać `ocl.exe`


![alt_text](images/image21.png "image_tooltip")




4. Opisz działania znajdujące się pod adresem 0x00401133.

    
![alt_text](images/image22.png "image_tooltip")



    Jest to ładowanie pojedynczych znaków ASCII na stos o następującej postaci:

* **1qaz2wsx3edc**
* **ocl.exe**
5. Podaj argumenty, które są przekazywane do podprogramu pod adresem 0x00401089?

    
![alt_text](images/image23.png "image_tooltip")



    są to poprzednio znalezione stringi

6. Podaj nazwę domeny, która wykorzystuje ten malware.

Standardowo [www.practicalmalwareanalysis.com](www.practicalmalwareanalysis.com)



7. Jaka procedura kodowania została zastosowana przez ten program do zaciemnienia nazwy domeny?

XOR


![alt_text](images/image24.png "image_tooltip")




8. Opisz znaczenie wywołania CreateProcessA znajdującego się pod adresem 0x0040106E w nawiązaniu do tego malware?


![alt_text](images/image25.png "image_tooltip")


Wykonuje on komendy wiersza poleceń `cmd`


## Laboratorium 5.3

Przeprowadź analizę pliku Lab06-03.exe za pomocą programu OllyDbg i IDA. Ten malware

ładuje dodatkowe 3 biblioteki DLL (DLL1.dll, DLL2.dll i DLL3.dll), które muszą znajdować

się w tej samej lokalizacji podczas ładowania do pamięci. Podczas przeglądania tych bibliotek DLL w OllyDbg, w porównaniu do IDA, mogą pojawiać się różnice w lokalizacji w pamięci.

Zadanie to ma na celu ułatwienie znalezienia poprawnej lokalizacji kodu w OllyDbg

w porównaniu do programu IDA. Odpowiedz na poniższe pytania:


### 1. Które biblioteki DLL są importowane przez Lab06-03.exe (np. PE-bear). Podaj te, które ładują się dynamicznie (IDA: funkcja LoadLibraryA).


![alt_text](images/image26.png "image_tooltip")




* KERNEL32.dll
* NETAPI32.dll
* DLL1.dll
* DLL2.dll

Dynamicznie `user32.dll`


![alt_text](images/image27.png "image_tooltip")



### 2. Podaj adres bazowy wymagany przez DLL1.dll, DLL2.dll i DLL3.dll (np. w PEview).


![alt_text](images/image28.png "image_tooltip")


Dla wszystkich 3 bibliotek jest to `0x100000000`


### 3. Wykorzystując OllyDbg do debugowania Lab06-03.exe podaj przypisany adres bazowy dla DLL1.dll, DLL2.dll i DLL3.dll.

DLL1.dll
![alt_text](images/image29.png "image_tooltip")


DLL2.dll
![alt_text](images/image30.png "image_tooltip")


DLL3.dll
![alt_text](images/image31.png "image_tooltip")



### 4. Opisz działanie importowanej funkcji z DLL1.dll wywoływanej przez Lab06-03.exe.


![alt_text](images/image32.png "image_tooltip")


Jest to funkcja odpowiedzialna za printowanie


![alt_text](images/image33.png "image_tooltip")



### 5. Jaką nazwę pliku wykorzystuje funkcja WriteFile podczas zapisu (Lab06-03.exe w związku z plikiem DLL2.dll)?


![alt_text](images/image34.png "image_tooltip")



```
temp.txt
```



### 6. Skąd pobierane są dane dla drugiego parametru z funkcji NetScheduleJobAdd?


![alt_text](images/image35.png "image_tooltip")



```
malwareanalysisbook.com
```



### 7. Podczas uruchamiania lub debugowania programu można zobaczyć, że wyświetla on trzy fragmenty tajemniczych danych. Z czym są powiązane: DLL 1 mystery data, DLL 2 mystery data i DLL 3 mystery data?

Nie było śladów wartości w samym pliku `Lab06-03.exe`

Są powiązane z samymi bibliotekami.

Po odpaleniu bibliotek w programie IDA można zobaczyć, że wartość tych mystery data to wartość PID
![alt_text](images/image36.png "image_tooltip")


W przypadku DLL2.dll chodzi o nawiązanie do pliku `temp.txt`


![alt_text](images/image37.png "image_tooltip")


W przypadku DLL3.dll wartość jest zależna od funkcji ping do strony www.malwareanalysisbook.com
![alt_text](images/image38.png "image_tooltip")



### 8. W jaki sposób można załadować DLL2.dll do IDA, aby było to zgodne z adresem ładowania zastosowanym przez OllyDbg?

Należy zmienić bazę programu


![alt_text](images/image39.png "image_tooltip")
