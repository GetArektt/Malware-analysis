# Zaawansowana analiza statystyczna


The aim of the laboratory is to present techniques and tools using practical examples
enabling disassembly of a file containing malware - using free version of IDA software in the form of links and viewing graphs to speed up the analysis.

Raport will include:
- finding information in the assembler code
- recognizing subroutines contained in the examined file
- network and host indicators 

## Laboratorium 4.1

Przeprowadź analizę pliku Lab04-01.dll za pomocą programu IDA i odpowiedz na poniższe

pytania:


### 1. Podaj adres DllMain (Może być konieczne włączenie wyświetlania nr linii w widoku grafowym – Options>General>Line Prefixes).

Brak takowej funkcji


### 2. Wykorzystaj opcje Imports i odszukaj funkcje gethostbyname. Pod jakim adresem można go odszukać?




0000000100163CC


### 3. Ile razy gethostbyname jest wywoływany oraz przez ile różnych funkcji (CTRL-X wywołuje okno z odsyłaczami)?




Był wywoływany 18 razy, przez 6 różnych funkcji


### 4. Pozostając w wywołaniu gethostbyname odszukaj adres 0x10001757 i spróbuj określić jakie żądanie DNS zostało wykonane (szybkie szukanie klawisz G).


pics.practicalmalwareanalysis.com


### 5. Podaj, ile zmiennych lokalnych program IDA rozpoznał dla podprogramu zaczynającego się od adresu 0x10001656?




brak znalezionych zmiennych


### 6. Ile parametrów rozpoznała IDA dla ww. adresu?

1 parameter  `25 __stdcal sub_10001656(LPVOID lpThreadParameter)`


### 7. Przy wykorzystaniu funkcji strings zlokalizuj łańcuch \cmd /c w zdeasemblowanym kodzie. Pod jakim adresem można go odszukać?




pod adresem `xdoors_d:10095B34`


### 8. Co dzieje się w obszarze kodu, który odwołuje się do \cmd.exe /c?

Przechowuje string `cmd.exe \c` następnie czyści bufor oraz rozpoczyna połączenie (socketa) `->` otrzymuje zdalnie komendę a następnie ją wykonuje





### 9. Pod adresem .text:100101C8 znajduje się zmienna dword_1008E5C4, która pomagazdecydować, jaką ścieżkę wybrać. W jaki sposób malware wykorzystuje zmienną dword_1008E5C4?




W xrefach występuje nawiązanie do funkcji `sub_10001656` która odpowiada za sprawdzenie wersji systemu windows `->` zwraca ją do zmiennej `dword_1008E5C4` i na podstawie jej wartości dobiera odpowiednią formę wywołania konsoli cmd





### 10. Odszukaj adres 0x1000FF58 znajdujący się w podprogramie kilkaset linii dalej, gdzie rozpoczyna się seria porównań wykorzystująca memcmp do porównywania łańcuchów. Podaj co się stanie, jeśli porównanie łańcuchów z robotwork (adres 0x10010452) zakończy się powodzeniem i memcmp zwróci 0?




zacznie wykonywać się kod do którego prowadzi czerwona strzałka




Co następnie wywołuje funkcje `sub_100052A2` która służy do sprawdzania software’u systemu Windows oraz otwarcia klucza reejstru




a następnie tworzy string, który łączy z kluczem rejestru 


oraz za pomocą odpowiedniego socketu wysyła go








### 11. Co robi eksport PLIST?










Funkcje odnoszą się do `CreateToolhelp32Snapshot` oraz pobierają PID procesów a następnie wysyłają je za pomocą socketa


### 12. Wykorzystaj funkcje graf do wyświetlenia sub_10004E79. Jakie funkcje API mogą być wywołane po wejściu do tej funkcji? Bazując na tych funkcjach API, jaką można jej nadać nazwę?




Funkcja ma za zadanie identyfikacje języka systemowego `->` można ją nazwać w stylu `GetSysLanguage()`


### 13. Podaj, ile funkcji WindowsAPI bezpośrednio wywołuje DllMain? A ile, jeśli weźmiemy pod uwagę głębokość 2?

Brak funkcji DllMain


### 14. Pod adresem 0x10001358 znajduje się wywołanie sleep (funkcja API, która przyjmuje jeden parametr określający liczbę milisekund uśpienia). Sprawdź jak długo ten kod zostanie w uśpieniu przy wykonaniu?




Najprawdopodobniej uśpienie trwa 30 sekund z uwagi na ten string

Kodu nie udało mi się uruchomić z uwagi na to iż jest to biblioteka





### 15. Pod adresem 0x10001701 znajduje się wywołanie socket. Podaj jego trzy parametry.




Protokół: 6

Typ: 1

Af: 2


### 16. Wyszukaj użycie funkcji in (kod 0xED). Ta instrukcja jest używana z łańcuchem VMXh do wykrywania VMware. Czy w tym pliku występuje tak funkcja? Czy korzystając z odsyłaczy do funkcji wykonującej instrukcje in, istnieje szansa na próbę wykrywania VMware? Podpowiedź: w darmowej wersji IDA należy ręcznie zmienić parametr kopiowany w eax z Hexa na ASCII PPM.

Udało się znaleźć taki string pod adresem 100061DB




Poniżej znajduje się wartość `564D5868h` zapisana w postaci HEX, która po skonwertowaniu daje string `VMXh`




Następnie w nawiązaniach funkcji udało się znaleźć procedure odmawiającą instalacji, jeśli została wykryta wirtualna maszyna  `aFoundVirtualMa`





### 17. Odszukaj adres 0x1001D988. Odpowiedz, co tam się znajduje?

Pierwotnie z pozoru ciąg losowych znaków

Po skonwertowaniu ich do czytelnej formy w znakach ASCII ukazuje się nadal dziwny napis




Po wklejeniu napisu do narzędzia znanego z CTF’ów `CyberChef` i wybrania opcji magic pokazuje się odkodowany napis - **is this backdoor**





## Laboratorium 4.2

Rozpoznawanie w Asemblerze konstrukcji języka C. Przy wykorzystaniu pliku Lab05-01.exe,

odpowiedz na poniższe pytania:


### 1. Jaka jest główna konstrukcja znajdująca się w jedynym podprogramie wywoływanym przez main?

Konstrukcja wygląda w następujący sposób - i jest to konstrukcja warunkowa typu `IF`




wywołuje ona funkcje `sub_401000` która wygląda następująco




Odpowiada ona za połączenia internetowe




Kod polega na sprawdzeniu czy jest połączenie internetowe 



* jeśli zwraca 1 to znaczy, że istnieje połączenie
* jeśli zwraca 0 to znaczy, że wystąpił błąd


### 2. Określ, jaki podprogram znajduje się pod adresem 0x40105F?




Najprawdopodobniej służy on do wyrzucania błędu z uwagi na brak połączenia - o treści `Error 1.1: No Internet\n`





### 3. W jaki sposób działa ten program?

Program sprawdza połączenie internetowe urządzenia i zwraca odpowiedni napis


## Laboratorium 4.3

Wykonaj analizę złośliwego oprogramowania znajdującego się w pliku Lab05-02.exe,

odpowiedz na poniższe pytania:


### 1. Sprawdź i określ rodzaj operacji wykonywanej przez pierwszy podprogram wywoływany przez main.




Podprogram działa na zasadzie programu z poprzedniego zadania - sprawdzanie czy istnieje połączenie internetowe


### 2. Opisz podprogram, który znajduję się pod adresem 0x40117F.




Po odpaleniu programu udało mi się stwierdzić iż powyższy kod odpowiada za wypisywanie napisu na ekran. Funkcja jest bardzo podobna do tej z poprzedniego zadania





### 3. Odszukaj drugi podprogram wywoływany przez funkcje main. Określ, co robi?




Jeśli jest połączenie internetowe to uruchamia on komendę systemową a następnie próbuje otworzyć przeglądarkę Internet Explorer 7.5 i otworzyć URL [http://www.practicalmalwareanalysis.com/](http://www.practicalmalwareanalysis.com/)

 i pobrać zdalnie zasób lub odczytać coś z pliku





### 4. Czy jesteś w stanie wskazać dwa istniejące indykatory sieciowe dla tego programu?

Jeden został znaleziony w poprzednim podpunkcie



*  [http://www.practicalmalwareanalysis.com/](http://www.practicalmalwareanalysis.com/)
* jeśli chodzi o drugi to nie udało mi się nigdzie znaleźć innego adresu URL lub czegoś podobnego. Być może chodzi o agenta: Internet Explorer 7.5/pma


### 5. Opisz cel tego złośliwego pliku.

Program najpierw sprawdza połączenie internetowe, jeśli istnieje to następnie wysyła zapytanie do strony [http://www.practicalmalwareanalysis.com/](http://www.practicalmalwareanalysis.com/) oraz zdalnie pobiera zasoby i najprawdpoodobniej odczytuje z pliku komendy, które ma następnie wykonać
